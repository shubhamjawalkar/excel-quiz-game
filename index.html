<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Excel & VBA Master Assessment</title>

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,#1f4037,#99f2c8);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}
.container{
    background:white;
    width:950px;
    max-width:95%;
    padding:35px;
    border-radius:18px;
    box-shadow:0 20px 50px rgba(0,0,0,0.25);
}
.card{
    background:#f7f9f8;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
}
input{
    width:100%;
    padding:12px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #ccc;
}
button{
    padding:12px 20px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    background:#1f4037;
    color:white;
    margin-top:10px;
}
button:hover{opacity:0.9}
.option{
    padding:12px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #ddd;
    cursor:pointer;
}
.option:hover{background:#f1f1f1}
.selected{
    background:#1f4037;
    color:white;
}
.progress{
    height:8px;
    background:#eee;
    border-radius:10px;
    margin-bottom:15px;
}
.progress-bar{
    height:8px;
    background:#1f4037;
    width:0%;
    border-radius:10px;
}
.timer{
    font-weight:bold;
    color:#d32f2f;
}
.leaderboard{
    max-height:150px;
    overflow:auto;
}
.dashboard-flex{
    display:flex;
    gap:30px;
    flex-wrap:wrap;
}
.badge{
    padding:6px 12px;
    border-radius:20px;
    font-weight:bold;
}
.pass{background:#d4edda;color:#155724}
.fail{background:#f8d7da;color:#721c24}
.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<!-- WELCOME -->
<div id="startScreen">

    <h2>Excel & VBA Master Assessment</h2>

    <div class="card">
        <h3>üèÜ Leaderboard</h3>
        <div id="leaderboardList" class="leaderboard">Loading...</div>
    </div>

    <div class="card">
        <h3>Start New Test</h3>
        <input type="text" id="name" placeholder="Enter Name">
        <input type="email" id="email" placeholder="Enter Email">
        <button onclick="startNewGame()">Start Test</button>

        <hr>

        <h3>Resume Test</h3>
        <input type="text" id="resumeId" placeholder="Enter Unique ID">
        <button onclick="resumeGame()">Resume</button>
    </div>
</div>

<!-- QUIZ -->
<div id="quizScreen" class="hidden">
    <div class="timer">‚è≥ Time Left: <span id="time">30:00</span></div>
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <h3 id="question"></h3>
    <div id="options"></div>
    <button onclick="nextQuestion()">Next</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
    <h2>Assessment Report</h2>

    <div class="dashboard-flex">
        <div class="card" style="text-align:center;">
            <h3>Score</h3>
            <h1 id="percentageText"></h1>
        </div>

        <div class="card">
            <p id="userInfo"></p>
            <p id="finalScore"></p>
            <p id="timeTaken"></p>
            <p id="performance"></p>
            <div id="passFail"></div>
        </div>
    </div>

    <button onclick="location.reload()">Restart</button>
</div>

</div>

<script>

/* ================= CONFIG ================= */

const API_URL="https://script.google.com/macros/s/AKfycbw_XB3KTyGXz-etw84Ttrvg1BWmzxH16fAM4MWOAMpY9qH4UqIqkDY9dQNpTUZdZNiu/exec";

/* ================= STATE ================= */

let userName="",userEmail="";
let current=0,score=0;
let selectedAnswer=null;
let timerInterval;
let timeRemaining=1800;

/* ================= LEVELS ================= */

// LEVEL 1 ‚Äì Basics
const level1=[
{q:"Which function returns row number?",o:["ROW","COLUMN","INDEX","CELL"],a:0},
{q:"Which function counts non-empty cells?",o:["COUNT","COUNTA","COUNTIF","SUM"],a:1},
{q:"Which function extracts left text?",o:["LEFT","RIGHT","MID","TEXT"],a:0},
{q:"Which function returns month?",o:["MONTH","DATE","YEAR","NOW"],a:0},
{q:"Which function returns current date?",o:["NOW","TODAY","DATE","TIME"],a:1}
];

// LEVEL 2 ‚Äì Intermediate
const level2=[
{q:"Which function handles errors?",o:["IFERROR","ERROR","TRY","ISERROR"],a:0},
{q:"Which function returns maximum?",o:["MAX","TOP","HIGH","LARGE"],a:0},
{q:"Which function returns minimum?",o:["MIN","LOW","BOTTOM","SMALL"],a:0},
{q:"Which function replaces text?",o:["REPLACE","SUBSTITUTE","CHANGE","SWAP"],a:1},
{q:"Which function trims spaces?",o:["TRIM","CLEAN","REMOVE","STRIP"],a:0}
];

// LEVEL 3 ‚Äì Advanced
const level3=[
{q:"Which function returns unique values?",o:["UNIQUE","FILTER","MATCH","INDEX"],a:0},
{q:"Which function joins text with delimiter?",o:["CONCAT","TEXTJOIN","JOIN","MERGE"],a:1},
{q:"Which function looks up vertically?",o:["HLOOKUP","VLOOKUP","INDEX","MATCH"],a:1},
{q:"Which Excel version introduced dynamic arrays?",o:["2010","2013","2016","365"],a:3},
{q:"Which function finds nth largest value?",o:["LARGE","MAX","TOP","HIGH"],a:0}
];

// LEVEL 4 ‚Äì Power Tools
const level4=[
{q:"Which feature summarizes data?",o:["Charts","Pivot Table","Formatting","Validation"],a:1},
{q:"Which tool removes duplicates?",o:["Filter","Remove Duplicates","Sort","Clean"],a:1},
{q:"Which feature builds data models?",o:["Power Pivot","Charts","Validation","Filter"],a:0},
{q:"Which tool forecasts trends?",o:["Pivot","Solver","Forecast Sheet","Macro"],a:2},
{q:"Which tool automates repetitive tasks?",o:["Macro","Filter","Sort","Validation"],a:0}
];

// LEVEL 5 ‚Äì VBA
const level5=[
{q:"What does VBA stand for?",o:["Visual Basic Application","Visual Basic for Applications","Virtual Basic","Visual Batch Automation"],a:1},
{q:"Shortcut to open VBA Editor?",o:["Alt+F8","Alt+F11","Ctrl+F11","Shift+F11"],a:1},
{q:"Which keyword declares variable?",o:["Dim","Set","Var","Let"],a:0},
{q:"Which statement handles errors?",o:["On Error","Error Handle","Try","Catch"],a:0},
{q:"Which object represents workbook?",o:["Sheet","Workbook","Range","Cell"],a:1}
];

// Combine levels
const questions=[...level1,...level2,...level3,...level4,...level5];

/* ================= UNIQUE ID ================= */

function generateUniqueID(){
    return "PLYR-"+Date.now().toString().slice(-6)+"-"+Math.floor(Math.random()*1000);
}

/* ================= START ================= */

function startNewGame(){
    userName=document.getElementById("name").value;
    userEmail=document.getElementById("email").value;
    if(!userName||!userEmail){alert("Enter Name & Email");return;}

    const id=generateUniqueID();

    localStorage.setItem("playerData",JSON.stringify({
        id:id,name:userName,email:userEmail,current:0,score:0,timeRemaining:1800
    }));

    alert("Your Unique ID: "+id);

    startGameEngine();
}

function resumeGame(){
    const entered=document.getElementById("resumeId").value;
    const saved=JSON.parse(localStorage.getItem("playerData"));

    if(saved && saved.id===entered){
        userName=saved.name;
        userEmail=saved.email;
        current=saved.current;
        score=saved.score;
        timeRemaining=saved.timeRemaining;
        startGameEngine();
    }else{
        alert("Invalid ID");
    }
}

function startGameEngine(){
    document.getElementById("startScreen").classList.add("hidden");
    document.getElementById("quizScreen").classList.remove("hidden");
    startTimer();
    loadQuestion();
}

/* ================= TIMER ================= */

function startTimer(){
    timerInterval=setInterval(()=>{
        timeRemaining--;
        let m=Math.floor(timeRemaining/60);
        let s=timeRemaining%60;
        document.getElementById("time").innerText=`${m}:${s<10?"0"+s:s}`;
        if(timeRemaining<=0){clearInterval(timerInterval);showDashboard();}
    },1000);
}

/* ================= QUIZ ================= */

function loadQuestion(){
    selectedAnswer=null;
    let q=questions[current];
    document.getElementById("question").innerText=(current+1)+". "+q.q;
    let html="";
    q.o.forEach((opt,i)=>{
        html+=`<div class="option" onclick="selectOption(this,${i})">${opt}</div>`;
    });
    document.getElementById("options").innerHTML=html;
    document.getElementById("progressBar").style.width=((current)/questions.length)*100+"%";
}

function selectOption(el,i){
    document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected"));
    el.classList.add("selected");
    selectedAnswer=i;
}

function nextQuestion(){
    if(selectedAnswer===null){alert("Select option");return;}
    if(selectedAnswer===questions[current].a){score++;}

    localStorage.setItem("playerData",JSON.stringify({
        id:JSON.parse(localStorage.getItem("playerData")).id,
        name:userName,email:userEmail,
        current:current+1,score:score,timeRemaining:timeRemaining
    }));

    current++;
    if(current<questions.length){loadQuestion();}
    else{showDashboard();}
}

/* ================= DASHBOARD ================= */

function showDashboard(){
    clearInterval(timerInterval);
    document.getElementById("quizScreen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");

    let percentage=Math.round((score/questions.length)*100);
    let timeUsed=1800-timeRemaining;

    document.getElementById("percentageText").innerText=percentage+"%";
    document.getElementById("userInfo").innerText=userName+" | "+userEmail;
    document.getElementById("finalScore").innerText="Score: "+score+" / "+questions.length;
    document.getElementById("timeTaken").innerText="Time: "+Math.floor(timeUsed/60)+"m "+(timeUsed%60)+"s";
    document.getElementById("performance").innerText="Level Completed: 5 Levels";

    document.getElementById("passFail").innerHTML=
        percentage>=60?'<span class="badge pass">PASS</span>':'<span class="badge fail">FAIL</span>';

    localStorage.removeItem("playerData");
}

/* ================= OPTIMIZED LEADERBOARD ================= */

async function loadLeaderboard(){
    const cache=localStorage.getItem("leaderboard_cache");
    const cacheTime=localStorage.getItem("leaderboard_cache_time");

    if(cache && cacheTime && (Date.now()-cacheTime<300000)){
        document.getElementById("leaderboardList").innerHTML=cache;
        return;
    }

    try{
        const res=await fetch(API_URL);
        const data=await res.json();
        const filtered=data.filter(r=>r[1]&&r[3]).sort((a,b)=>b[3]-a[3]).slice(0,5);

        let html="";
        filtered.forEach((row,i)=>{
            html+=`<div>${i+1}. ${row[1]} - ${row[3]}</div>`;
        });

        document.getElementById("leaderboardList").innerHTML=html||"No attempts yet.";
        localStorage.setItem("leaderboard_cache",html);
        localStorage.setItem("leaderboard_cache_time",Date.now());

    }catch{
        document.getElementById("leaderboardList").innerHTML="Unable to load leaderboard.";
    }
}

loadLeaderboard();

</script>
</body>
</html>
